#!/usr/bin/env bash
#
# retry - run and rerun a command if it fails
#
# usage:
#
#   retry <retries> [msg] -- <command>
#
MAX_RETRIES="${1:-number of retry attempts must be provided}"
MSG=""
shift 1

until [[ "$1" = "--" ]]; do
    if [[ "$#" -eq 0 ]]; then
        echo "ERROR: command must be given after a '--' argument." >&2
        echo "       example: '$0 5 -- curl -L https://checkip.amazonaws.com'" >&2
        exit 2
    fi
    MSG="${1:+$MSG $1}"
    shift 1
done
MSG="${MSG:+ - $MSG}"

for i in $(seq 1 "$MAX_RETRIES"); do
    eval "${@}"
    ret=$?
    if [[ "$ret" -eq 0 ]]; then
        exit 0
    fi
    if [[ "$i" -eq "$MAX_RETRIES" ]]; then
        echo "FAIL: retries exhausted$MSG"
        exit 1
    fi
done

exit 3
