#!/usr/bin/env bash
#
# retry - run and rerun a command if it fails
#
# usage:
#
#   retry <retries> [msg] -- <command>
#
MAX_RETRIES="${1:-number of retry attempts must be provided}"
MSG=""
shift 1

until [[ "$1" = "--" ]]; do
    if [[ "$#" -eq 0 ]]; then
        logger -s -t ERROR <<EOF
command must be given after a '--' argument.
example retry: '$0 5 -- curl -L https://checkip.amazonaws.com'
EOF
        exit 2
    fi
    MSG="${1:+$MSG $1}"
    shift 1
done
shift 1 # drop '--'

for i in $(seq 1 "$MAX_RETRIES"); do
    if "${@}"; then
        exit 0
    fi
    if [[ "$i" -eq "$MAX_RETRIES" ]]; then
        logger -s -t ERROR "retries exhausted${MSG:+ - $MSG}"
        exit 1
    fi
done

exit 3
