#!/usr/bin/env sh
#
# setup-rust-builder - install rust and configure shell for its use by a builder
#
# This script is expected to be sourced by callers in order to affect their PATH
# directly AND is used in CodeBuild environments where the SHELL is /bin/sh.
#
# usage:
#
#   . setup-rust-builder
#

configure_color() {
    # Prepare Cargo for build and CI usage
    PATH="$HOME/.cargo/bin:$PATH"
    mkdir -p .cargo "$HOME/.cargo/bin"
    # Configure Cargo to print without ascii coloring.
    printf '\n[term]\nverbose = false\ncolor = "never"\n' \
        | tee -a ".cargo/config" "$HOME/.cargo/config" >/dev/null

    # Configure cargo-build to print without ascii coloring.
    install -d "$HOME/.config/cargo-make"
    printf '\ndisable_color = true\n' >> "$HOME/.config/cargo-make/config.toml"
}

configure_color

# Use rustup to install rust toolchain
if ! curl --proto '=https' --tlsv1.2 -sS "https://sh.rustup.rs" | bash -s -- -y --no-modify-path --default-toolchain stable; then
    logmsg "ERROR: could not install rustup to install a rust toolchain"
    exit 1
fi

# Install build tooling dependencies
cargo install --force cargo-make
cargo install --force cargo-deny

unset -f configure_color

