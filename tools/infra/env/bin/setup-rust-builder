#!/usr/bin/env sh
#
# setup-rust-builder - install rust and configure shell for its use by a builder
#
# This script is expected to be sourced by callers in order to affect their PATH
# directly AND is used in CodeBuild environments where the SHELL is /bin/sh.
#
# usage:
#
#   . setup-rust-builder
#

configure_color_output() {
    # Prepare Cargo for build and CI usage
    PATH="$HOME/.cargo/bin:$PATH"
    mkdir -p .cargo "$HOME/.cargo/bin"
    # Configure Cargo to print without ascii coloring.
    printf '\n[term]\nverbose = false\ncolor = "never"\n' \
        | tee -a ".cargo/config" "$HOME/.cargo/config" >/dev/null

    # Configure cargo-build to print without ascii coloring.
    install -d "$HOME/.config/cargo-make"
    printf '\ndisable_color = true\n' >> "$HOME/.config/cargo-make/config.toml"
}

cargo_dep() {
    cargo_install_package="$1"
    if ! cargo install --force "$cargo_install_package"; then
        logmsg "ERROR: could not install cargo packaged dependency: $cargo_install_package"
        exit 1
    fi
}

install_rust_toolchain() {
    test -f rustup-init.sh || rm -f rustup-init.sh
    if ! curl -o rustup-init.sh --proto '=https' --tlsv1.2 -sS "https://sh.rustup.rs"; then
        logmsg "ERROR: could not fetch rustup, needed for managing rust toolchain"
        exit 1
    fi
    if ! bash rustup-init.sh -y --no-modify-path --default-toolchain stable ; then
        logmsg "ERROR: could not setup rustup & rust toolchain for build"
        exit 1
    fi
    rm -f rustup-init.sh
}

configure_color_output

install_rust_toolchain

# Install build tooling dependencies
cargo_dep cargo-make
cargo_dep cargo-deny

unset -f configure_color_output
unset -f install_rust_toolchain
unset -f cargo_dep

