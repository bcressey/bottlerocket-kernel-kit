Resources:
  BuildArtifactBucket:
    Type: AWS::S3::Bucket
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  BuildLogBucket:
    Type: AWS::S3::Bucket
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  BuildRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
  BuildRolePolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - cloudformation:ValidateTemplate
            Effect: Allow
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject*
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - BuildArtifactBucket
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - BuildArtifactBucket
                        - Arn
                    - /*
              - Fn::GetAtt:
                  - BuildLogBucket
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - BuildLogBucket
                        - Arn
                    - /*
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/codebuild/
                    - Ref: InfraPullRequestBuild
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/codebuild/
                    - Ref: InfraPullRequestBuild
                    - :*
        Version: "2012-10-17"
      PolicyName: BuildRolePolicy
      Roles:
        - Ref: BuildRole
  InfraPullRequestBuild:
    Type: AWS::CodeBuild::Project
    DependsOn:
      - BuildArtifactBucket
      - BuildLogBucket
      - BuildRole
    Properties:
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:2.0
        Type: LINUX_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - BuildRole
          - Arn
      Source:
        BuildSpec: tools/infra/buildspec/infra-pr-build.yml
        Location: https://github.com/amazonlinux/PRIVATE-thar.git
        ReportBuildStatus: true
        Type: GITHUB
      LogsConfig:
        S3Logs:
          Status: ENABLED
          Location:
            Fn::Join:
              - "/"
              - - Fn::GetAtt:
                  - BuildArtifactBucket
                  - Arn
                - "codebuild/log"
        CloudWatchLogs:
          Status: ENABLED
      TimeoutInMinutes: 10
      Triggers:
        Webhook: true
        FilterGroups:
          - - Type: EVENT
              Pattern: PULL_REQUEST_CREATED,PULL_REQUEST_UPDATED
Outputs:
  ArtifactBucket:
    Value:
      Ref: BuildArtifactBucket
  LogBucket:
    Value:
      Ref: BuildLogBucket
  Project:
    Value:
      Ref: InfraPullRequestBuild
