#!/usr/bin/env bash
set -euo pipefail

KEYPAIR_NAME="${KEYPAIR_NAME:?Need a keypair name}"
KEYPAIR_PARAMETER="${KEYPAIR_PARAMETER:?Need a parameter name}"

logger() {
    command logger --stderr --no-act "$@"
}

ssh_keypair="$(mktemp -u -t "ssm-key-pair.XXX")"
# shellcheck disable=2064
trap "rm -f -- '$ssh_keypair' '$ssh_keypair.pub'" EXIT

if aws ssm get-parameter --name "$KEYPAIR_PARAMETER" &>/dev/null; then
    : SSM Secure Parameter exists
else
    logger -t INFO "creating SSM parameter ssh key-pair"
    mkfifo "$ssh_keypair" "${ssh_keypair}.pub"
    yes | ssh-keygen -P '' -C "$KEYPAIR_NAME" -f "$ssh_keypair" &
    aws ssm put-parameter --overwrite --name "$KEYPAIR_PARAMETER" --type SecureString --value "$(<"$ssh_keypair")" >/dev/null
fi

if aws ec2 describe-key-pairs --key-name "$KEYPAIR_NAME" &>/dev/null ; then
    : EC2 Key Pair exists
else
    if [ -e "${ssh_keypair}.pub" ]; then
	logger -t INFO "importing ssh key from newly generated pair"
    else
	logger -t INFO "importing ssh key from SSM parameter '$KEYPAIR_PARAMETER'"

	ssh-keygen -y -f <(aws ssm get-parameter --name "$KEYPAIR_PARAMETER" \
						 --with-decryption \
						 --query Parameter.Value \
						 --output text) \
	  > "${ssh_keypair}.pub"
	# shellcheck disable=SC2181
	if [ "$?" -ne 0 ]; then
	    logger -t ERROR "could not import ssh key from SSM parameter"
	    exit 1
	fi
    fi


    aws ec2 import-key-pair --key-name "$KEYPAIR_NAME" --public-key-material file://"${ssh_keypair}.pub"
    logger -t INFO "imported ssh key as EC2 key pair '$KEYPAIR_NAME'"
fi
