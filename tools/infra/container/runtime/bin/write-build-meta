#!/usr/bin/env bash
#
# write-build-meta - collect and write out build job details
#
has_command() { type "$1" &>/dev/null; }

write_common() {
    echo "${USER}" > build-user
    if has_command hostname; then
        hostname --fqdn > build-host
    elif [[ -f "/etc/hostname" ]]; then
        cat /etc/hostname > build-host
    else
        echo "unknown" > build-host
    fi
}

write_codebuild() {
    echo "codebuild" > build-service
    echo "${CODEBUILD_RESOLVED_SOURCE_VERSION}" > build-commit
    echo "${CODEBUILD_BUILD_ID}" > build-id
    echo "${CODEBUILD_INITIATOR}" > build-initiator
    echo "${CODEBUILD_BUILD_URL}" > build-url
    echo "${CODEBUILD_BUILD_ARN}" > build-codebuild-arn
}

if ! { mkdir -p "build/meta" && cd "build/meta"; }; then
    logger -s -t ERROR "could not create build/meta directory for writing"
    exit 1
fi

write_common

if [[ -n "${CODEBUILD_BUILD_ID}" ]]; then
    write_codebuild
fi

if [[ ! -s "build-service" ]]; then
    logger -s -t WARN "unknown service, cannot write out CI build metadata"
    echo "unknown" > build-service
    exit 0
fi
