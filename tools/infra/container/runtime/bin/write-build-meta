#!/usr/bin/env bash
#
# write-build-meta - collect and write out build job & environment details
#

# shellcheck source=../lib/lib.bash
source "${RUNTIME_SCRIPT_LIB:-../lib}/lib.bash"

write_common() {
    echo "${USER}" > build-user
    if has_command hostname; then
        hostname --fqdn > build-host
    elif [[ -f "/etc/hostname" ]]; then
        cat /etc/hostname > build-host
    else
        echo "unknown" > build-host
    fi
}

write_codebuild() {
    echo "codebuild" > build-service
    echo "${CODEBUILD_RESOLVED_SOURCE_VERSION}" > build-commit
    echo "${CODEBUILD_BUILD_ID}" > build-id
    echo "${CODEBUILD_INITIATOR}" > build-initiator
    echo "${CODEBUILD_BUILD_URL}" > build-url
    echo "${CODEBUILD_BUILD_ARN}" > build-codebuild-arn
}

if ! mkdir -p "build/meta"; then
    logger -t ERROR "could not create build/meta directory for writing"
    exit 1
fi
cd build/meta

# Write build environment information to disk

write_common

if [[ -n "${CODEBUILD_BUILD_ID}" ]]; then
    write_codebuild
fi

if [[ ! -s "build-service" ]]; then
    logger -t WARN "unknown service, cannot write out CI build metadata"
    echo "unknown" > build-service
    exit 0
fi
